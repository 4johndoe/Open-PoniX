#!/bin/sh

. $TS_GLOBAL

schedule_daily()
{
	TIME=$1
	CMD=$2

	HOUR=`echo "$TIME" | cut -c1-2`
	MIN=`echo "$TIME" | cut -c4-5`

	RES=`echo "$HOUR" | awk '{
		if ( $0 !~ /^[0-9]+$/ ) { print "Hour is not a number!"; exit; };
		if ( $0 < 0 || $0 > 23 ) { print "Hour is not in range!"; exit; }
		}'`

	if [ -n "$RES" ] ; then
		echo $RES
		exit	
	fi

	RES=`echo "$MIN" | awk '{
		if ( $0 !~ /^[0-9]+$/ ) { print "Minute is not a number!"; exit; };
		if ( $0 < 0 || $0 > 59 ) { print "Minute is not in range!"; exit; }
		}'`

	if [ -n "$RES" ] ; then
		echo $RES
		exit	
	fi
	
#	echo "H=$HOUR, M=$MIN, CMD='$CMD', RES='$RES'"
	echo "$MIN $HOUR * * *  $CMD" >> /tmp/crontab

}


case "$1" in  
init)
    if ! pkg_initialized $PACKAGE; then
	pkg_set_init_flag $PACKAGE
	crond

	if [ -n "$REBOOT_DAILY" ] ; then
		schedule_daily "$REBOOT_DAILY" "/bin/reboot"	
	fi

	if [ -n "$SHUTDOWN_DAILY" ] ; then
		schedule_daily "$SHUTDOWN_DAILY" "/bin/shutdown"	
	fi

	echo "0  * * * * /bin/checklogs" >> /tmp/crontab
	crontab /tmp/crontab
    fi
    ;;
help)
    echo "Usage: $0 init"
    ;;
  *)
    exit 1
    ;;
esac

exit 0
